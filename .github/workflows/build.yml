name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    name: Build and Test
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Backend
        uses: docker/build-push-action@v5
        with:
          context: ./Backend
          file: ./Backend/Dockerfile
          push: false
          tags: cyber-backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./Frontend
          file: ./Frontend/Dockerfile
          push: false
          tags: cyber-frontend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # TODO: Add test steps here when tests are implemented
      # - name: Run Backend Tests
      #   run: docker run --rm cyber-backend:${{ github.sha }} bun test

      # - name: Run Frontend Tests
      #   run: docker run --rm cyber-frontend:${{ github.sha }} bun test

  deploy:
    name: Deploy to Production
    runs-on: self-hosted
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create nginx network if not exists
        run: |
          docker network create nginxNetwork 2>/dev/null || echo "Network already exists"

      - name: Create .env file from secrets
        run: |
          cat > .env <<EOF
          DATABASE=${{ secrets.DATABASE }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRES_IN=${{ secrets.JWT_EXPIRES_IN }}
          LOG_LEVEL=${{ secrets.LOG_LEVEL }}
          SYSLOG_ENABLED=${{ secrets.SYSLOG_ENABLED }}
          SYSLOG_TENANT=${{ secrets.SYSLOG_TENANT }}
          ENRICHMENT_ENABLED=${{ secrets.ENRICHMENT_ENABLED }}
          ENRICHMENT_DNS=${{ secrets.ENRICHMENT_DNS }}
          ENRICHMENT_GEOIP=${{ secrets.ENRICHMENT_GEOIP }}
          RETENTION_ENABLED=${{ secrets.RETENTION_ENABLED }}
          RETENTION_DEFAULT_DAYS=${{ secrets.RETENTION_DEFAULT_DAYS }}
          EOF

      - name: Deploy with Docker Compose
        run: |
          # Use production compose file if NGINX_NETWORK secret is set
          if [ -n "${{ secrets.NGINX_NETWORK }}" ]; then
            echo "Deploying with external nginx network"
            docker compose -f docker-compose.yml -f docker-compose.prod.yml down
            docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build
          else
            echo "Deploying in standalone mode"
            docker compose down
            docker compose up -d --build
          fi
          docker compose ps

      - name: Restart Nginx (Production)
        if: ${{ secrets.NGINX_NETWORK != '' }}
        run: |
          # Restart nginx container to reload configuration
          NGINX_CONTAINER="${{ secrets.NGINX_CONTAINER_NAME }}"
          if [ -z "$NGINX_CONTAINER" ]; then
            # Try common nginx container names
            NGINX_CONTAINER=$(docker ps --filter "ancestor=nginx:latest" --format "{{.Names}}" | head -n 1)
            if [ -z "$NGINX_CONTAINER" ]; then
              NGINX_CONTAINER=$(docker ps --filter "name=nginx" --format "{{.Names}}" | head -n 1)
            fi
          fi

          if [ -n "$NGINX_CONTAINER" ]; then
            echo "Restarting nginx container: $NGINX_CONTAINER"
            docker restart "$NGINX_CONTAINER"
            echo "Waiting for nginx to be ready..."
            sleep 5
          else
            echo "Warning: Could not find nginx container. Set NGINX_CONTAINER_NAME secret if restart fails."
          fi

      - name: Clean up
        if: always()
        run: rm -f .env

      - name: Health Check
        run: |
          echo "Waiting for services to be healthy..."
          sleep 30
          docker compose ps

          # Check based on deployment mode
          if [ -n "${{ secrets.NGINX_NETWORK }}" ]; then
            echo "Production mode: checking via external nginx"
            # In production, frontend is accessed via external nginx
            # Check container health directly
            docker exec cyber-frontend wget -qO- http://localhost:80/api/health || exit 1
            echo "Backend is healthy (via frontend proxy)"

            docker exec cyber-frontend wget -qO- http://localhost:80 || exit 1
            echo "Frontend is healthy"
          else
            echo "Standalone mode: checking exposed ports"
            # Check backend health via frontend proxy
            curl -f http://localhost:5173/api/health || exit 1
            echo "Backend is healthy (via proxy)"

            # Check frontend
            curl -f http://localhost:5173 || exit 1
            echo "Frontend is healthy"
          fi
